{% extends "foundation.html" %}
{% block head %}
<title>LogoGrab WebScanner</title>
{% load static %}
<link rel="stylesheet" href="{% static 'style.css' %}" type="text/css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js">
</script>
<script src="https://www.logograb.com/webscanners/js/jquery-logograb.webscanner.min.js">
</script>
{% endblock %}
{% block body %}
<div class="container">  
    <button id="btn-snap" onclick="snap()">Take screenshot</button>      
    <video autoplay="true" id="videoElement"></video>
    <canvas width="364" height="204"></canvas>
    </div>
  <div class="wrapper">
  <div id="stage_grab">
  <div class="container">
      <button id="logoGrabWebScannerButton">Tap to grab</button>
      <div id="stage_result"></div>
  </div>
  <br/><br/>
  </div>
  </div>


  <script>
      var video = document.querySelector("#videoElement");

if (navigator.mediaDevices.getUserMedia) {
  navigator.mediaDevices.getUserMedia({ video: true })
    .then(function (stream) {
      video.srcObject = stream;
    })
    .catch(function (err0r) {
      console.log("Something went wrong!");
    });
}
var canvas = document.querySelector('canvas');
		// Get a handle on the 2d context of the canvas element
		var context = canvas.getContext('2d');
		// Define some vars required later
		var w, h, ratio;
		
		// Add a listener to wait for the 'loadedmetadata' state so the video's dimensions can be read
		video.addEventListener('loadedmetadata', function() {
			// Calculate the ratio of the video's width to height
			ratio = video.videoWidth / video.videoHeight;
			// Define the required width as 100 pixels smaller than the actual video's width
			w = video.videoWidth - 100;
			// Calculate the height based on the video's width and the ratio
			h = parseInt(w / ratio, 10);
			// Set the canvas width and height to the values just calculated
			canvas.width = w;
			canvas.height = h;			
		}, false);
		
		// Takes a snapshot of the video
		function snap() {
			// Define the size of the rectangle that will be filled (basically the entire element)
			context.fillRect(0, 0, w, h);
			// Grab the image from the video
            var pic = context.drawImage(video, 0, 0, w, h);
        }
  $('#logoGrabWebScannerButton').logoGrabWebScanner({
   developerKey: 'nb9n3ra9fpmrk0u0binh2b03jr3acq510tqhldmr',
   onInputImage: function(imageData) {
    // Callback invoked after the image has been uploaded to the device
   }, 
   onStart: function() {
    // Callback invoked before the image is uploaded to the server
   },
   onEnd: function(response) {
    // Callback invoked when the response JSON is returned
    if (!response.logoName)
     $('#stage_result').html("No result");
    else
     $('#stage_result').html(response.logoName);
    function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
    var csrftoken = getCookie('csrftoken');
 
    const url = "http://127.0.0.1:8000/mvpLogoGrab/data/?name="+ response.logoName;
    fetch(url,{
        method: "POST", // *GET, POST, PUT, DELETE, etc.
        headers: {
            "Content-Type": "application/json",
            'X-CSRFToken': csrftoken
            // "Content-Type": "application/x-www-form-urlencoded",
        },
        credentials: "include",
        body: JSON.stringify(response.logoName), // body data type must match "Content-Type" header
    })
    .then(response => response.json() // parses JSON response into native Javascript objects 
    ).then(
    html => console.log(html)
);
    window.location.replace(url);
    
    }
   }
  );
  </script>
  
{% endblock %}  

